generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id          Int       @id @default(autoincrement())
  shopDomain  String    @unique @map("shop_domain")
  accessToken String?   @map("access_token")
  email       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  users          User[]
  customers      Customer[]
  products       Product[]
  orders         Order[]
  abandonedCarts AbandonedCart[]
  checkouts      Checkout[]

  @@map("tenants")
}

model User {
  id           Int      @id @default(autoincrement())
  email        String   @unique
  passwordHash String   @map("password_hash")
  tenantId     Int      @map("tenant_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("users")
}

model Customer {
  id          BigInt   @id
  tenantId    Int      @map("tenant_id")
  email       String?
  firstName   String?  @map("first_name")
  lastName    String?  @map("last_name")
  ordersCount Int      @default(0) @map("orders_count")
  totalSpent  Decimal  @default(0) @db.Decimal(10, 2) @map("total_spent")
  createdAt   DateTime @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders Order[]
  
  abandonedCarts AbandonedCart[]

  @@unique([id, tenantId])
  @@index([tenantId])
  @@index([email])
  @@map("customers")
}

model Product {
  id          BigInt   @id
  tenantId    Int      @map("tenant_id")
  title       String
  vendor      String?
  productType String?  @map("product_type")
  price       Decimal  @default(0) @db.Decimal(10, 2)
  inventory   Int      @default(0)
  createdAt   DateTime @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lineItems OrderLineItem[]

  @@unique([id, tenantId])
  @@index([tenantId])
  @@map("products")
}

model Order {
  id                BigInt          @id
  tenantId          Int             @map("tenant_id")
  customerId        BigInt?         @map("customer_id")
  orderNumber       Int             @map("order_number")
  totalPrice        Decimal         @db.Decimal(10, 2) @map("total_price")
  subtotalPrice     Decimal         @db.Decimal(10, 2) @map("subtotal_price")
  totalTax          Decimal         @db.Decimal(10, 2) @map("total_tax")
  financialStatus   String          @map("financial_status")
  fulfillmentStatus String?         @map("fulfillment_status")
  createdAt         DateTime        @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer  Customer?       @relation(fields: [customerId, tenantId], references: [id, tenantId])
  lineItems OrderLineItem[]

  @@unique([id, tenantId])
  @@index([tenantId])
  @@index([customerId])
  @@index([createdAt])
  @@map("orders")
}

model OrderLineItem {
  id        Int     @id @default(autoincrement())
  orderId   BigInt  @map("order_id")
  tenantId  Int     @map("tenant_id")
  productId BigInt? @map("product_id")
  title     String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  order   Order    @relation(fields: [orderId, tenantId], references: [id, tenantId], onDelete: Cascade)
  product Product? @relation(fields: [productId, tenantId], references: [id, tenantId])

  @@index([orderId, tenantId])
  @@map("order_line_items")
}


model AbandonedCart {
  id            Int      @id @default(autoincrement())
  tenantId      Int      @map("tenant_id")
  cartToken     String   @map("cart_token")
  
  customerId    BigInt?  @map("customer_id")
  customer      Customer? @relation(fields: [customerId, tenantId], references: [id, tenantId])
  
  customerEmail String?  @map("customer_email")
  totalPrice    Decimal? @db.Decimal(10, 2) @map("total_price")
  abandonedAt   DateTime @map("abandoned_at")
  lineItems     Json?    @map("line_items")
  createdAt     DateTime @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([cartToken, tenantId])
  @@index([tenantId])
  @@index([customerEmail])
  @@map("abandoned_carts")
}


model Checkout {
  id            BigInt   @id
  tenantId      Int      @map("tenant_id")
  customerId    BigInt?  @map("customer_id")
  customerEmail String?  @map("customer_email")
  totalPrice    Decimal  @db.Decimal(10, 2) @map("total_price")
  completed     Boolean  @default(false)
  createdAt     DateTime @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([id, tenantId])
  @@index([tenantId])
  @@map("checkouts")
}
